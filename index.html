function caricaMarker() {
    markers.clearLayers();
    const searchName = document.getElementById('search-name').value.toLowerCase().trim();
    const searchLoc = document.getElementById('search-location').value.toLowerCase().trim();
    const regSel = document.getElementById('filtro-regione').value;
    const dropdown = document.getElementById('search-dropdown');
    let filtrati = [];

    database.forEach((d, index) => {
        // 1. Identifichiamo il valore della città (colonna D: città_nascita)
        // Usiamo sia la chiave con 'à' che un fallback per sicurezza
        const cittaNascita = (d['città_nascita'] || d['citta_nascita'] || "").toLowerCase();
        const nominativo = (d.nominativo || "").toLowerCase();
        const regione = (d.regione || "").toLowerCase();

        // 2. Logica dei filtri
        const matchName = nominativo.includes(searchName);
        
        // La ricerca per "Località" ora cerca specificamente in città_nascita
        const matchLoc = cittaNascita.includes(searchLoc);
        
        const matchReg = !regSel || d.regione === regSel;
        
        // 3. Coordinate
        let lat = parseFloat((d.lat || "").replace(',','.'));
        let lon = parseFloat((d.lon || "").replace(',','.'));

        if (matchName && matchLoc && matchReg && !isNaN(lat)) {
            let m = L.marker([lat, lon]);
            m.bindTooltip(d.nominativo, { direction: 'top', offset: [0, -10] });
            m.on('click', (e) => { 
                L.DomEvent.stopPropagation(e); 
                openDetails(d); 
            });
            markers.addLayer(m);
            filtrati.push({d, index});
        }
    });

    // 4. Gestione Dropdown Risultati
    if (searchName.length > 1 || searchLoc.length > 1) {
        if (filtrati.length > 0) {
            dropdown.style.display = 'block';
            dropdown.innerHTML = filtrati.slice(0, 15).map(item => {
                const luogo = item.d['città_nascita'] || item.d['citta_nascita'] || item.d.regione;
                return `
                <div class="dropdown-item" onclick="zoomToPartigiano(${item.index})">
                    <strong>${item.d.nominativo}</strong> 
                    <span style="font-size:11px; color:#666; margin-left:5px;">(${luogo})</span>
                </div>`;
            }).join('');
        } else {
            dropdown.innerHTML = '<div class="dropdown-item">Nessun risultato trovato</div>';
            dropdown.style.display = 'block';
        }
    } else {
        dropdown.style.display = 'none';
    }
}
