<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Archivio Partigiani - Mappa AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>

<!-- FILTRI / RICERCA -->
<div id="ui-container">
    <div id="filter-bar">
        <button onclick="location.reload()" style="background:none; border:none; cursor:pointer; font-size:18px;">↺</button>
        <input type="text" id="search-name" placeholder="Cognome..." oninput="filtra('name')">
        <input type="text" id="search-theme" placeholder="Temi..." oninput="filtra('theme')">
        <input type="text" id="search-city" placeholder="Città..." oninput="filtra('city')">
        <select id="filtro-regione" onchange="filtraRegione()">
            <option value="">Tutte le Regioni</option>
            <option value="Abruzzo">Abruzzo</option>
            <option value="Basilicata">Basilicata</option>
            <option value="Calabria">Calabria</option>
            <option value="Campania">Campania</option>
            <option value="Emilia-Romagna">Emilia-Romagna</option>
            <option value="Friuli Venezia Giulia">Friuli Venezia Giulia</option>
            <option value="Lazio">Lazio</option>
            <option value="Liguria">Liguria</option>
            <option value="Lombardia">Lombardia</option>
            <option value="Marche">Marche</option>
            <option value="Molise">Molise</option>
            <option value="Piemonte">Piemonte</option>
            <option value="Puglia">Puglia</option>
            <option value="Sardegna">Sardegna</option>
            <option value="Sicilia">Sicilia</option>
            <option value="Toscana">Toscana</option>
            <option value="Trentino-Alto Adige">Trentino-Alto Adige</option>
            <option value="Umbria">Umbria</option>
            <option value="Valle d'Aosta">Valle d'Aosta</option>
            <option value="Veneto">Veneto</option>
        </select>
    </div>
    <div id="results-dropdown"></div>
</div>

<!-- MAPPA -->
<div id="map"></div>

<!-- PANNELLO DETTAGLI PARTIGIANO -->
<div id="details-panel">
    <div id="details-header">
        <div>
            <b id="h-nome">NOMINATIVO</b> 
            <span id="h-reg" style="background:var(--blue); padding:2px 8px; border-radius:10px; font-size:10px; margin-left:10px;">REGIONE</span>
        </div>
        <button onclick="closeDetails()" style="background:none; border:none; color:white; font-size:30px; cursor:pointer;">&times;</button>
    </div>
    <div id="details-content">
        <div class="main-col">
            <div class="video-box">
                <iframe id="vimeo-player" src="" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="bio-box">
                <p id="text-bio"></p>
            </div>
        </div>
        <div class="side-rel">
            <div id="box-rel-list"></div>
            <div id="box-social"></div>
        </div>
    </div>
</div>

<!-- BOTTONE APERTURA CHAT AI -->
<div id="ai-chat-toggle" onclick="toggleAIChat()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
</div>

<!-- FINESTRA CHAT AI -->
<div id="ai-chat-window">
    <div style="background:#1a2a3a; color:white; padding:12px; font-weight:700; display:flex; justify-content:space-between; align-items:center;">
        <span>Assistente_Archivio w.1.4</span>
        <span onclick="toggleAIChat()" style="cursor:pointer; padding: 5px 15px; font-size: 24px;">&times;</span>
    </div>

    <div id="ai-chat-messages"></div>

    <!-- BARRA DI PROGRESSO — attivata/disattivata via JS durante lo streaming -->
    <div id="ai-progress-container">
        <div id="ai-progress-bar"></div>
    </div>

    <div style="padding:10px; background:#fff; border-top:1px solid #eee; display:flex; align-items:flex-end; gap:8px;">
        <textarea 
            id="ai-chat-input" 
            placeholder="Chiedi all'AI..." 
            rows="1" 
            style="flex:1; border:1px solid #ccc; border-radius:10px; padding:8px 12px; font-size:14px; outline:none; resize:none; font-family:inherit;"
            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
            onkeypress="if(event.key==='Enter' && !event.shiftKey){ event.preventDefault(); sendAIMessage(); }">
        </textarea>
        <button 
            onclick="sendAIMessage()" 
            style="background:#1a2a3a; border:none; border-radius:50%; width:35px; height:35px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </div>
</div>

<!-- LIBRERIE -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="testo_libro.js"></script>
<script src="app.js"></script>

</body>
</html>
