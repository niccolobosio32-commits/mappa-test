<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archivio Partigiani - Mappa AI Completa</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        :root { --navy: #1a2a3a; --blue: #3498db; --glass: rgba(255, 255, 255, 0.4); --red: #e21118; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Inter', sans-serif; overflow: hidden; background: #000; }
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; }

        .citazione-libro { display: block; border-left: 3px solid var(--red); background: rgba(0,0,0,0.05); padding: 8px; margin: 10px 0; font-style: italic; font-size: 0.85em; color: #444; }

        #ui-container { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 95%; max-width: 1100px; }
        #filter-bar { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); padding: 8px 15px; border-radius: 50px; display: flex; gap: 8px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #filter-bar input, #filter-bar select { border: none; outline: none; flex: 1; font-size: 13px; background: transparent; font-weight: 700; color: #000; min-width: 80px; }
        
        #results-dropdown { background: white; border-radius: 15px; margin-top: 5px; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .res-item { padding: 10px 20px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; display: flex; justify-content: space-between; font-weight: 600; }
        .res-item:hover { background: var(--blue); color: white; }

        #details-panel { position: absolute; top: 55%; left: 50%; transform: translate(-50%, 160%); width: 94%; max-width: 1100px; z-index: 4000; background: var(--glass); backdrop-filter: blur(35px); transition: transform 0.6s ease; border-radius: 25px; display: flex; flex-direction: column; overflow: hidden; max-height: 85vh; border: 1px solid rgba(255,255,255,0.5); }
        #details-panel.open { transform: translate(-50%, -50%); }
        
        #details-header { background: rgba(26, 42, 58, 0.9); color: white; padding: 8px 20px; display: flex; justify-content: space-between; align-items: center; }
        .social-btn { cursor: pointer; font-size: 14px; margin-left: 10px; font-weight: bold; }

        .main-col { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; }
        .bio-box { padding: 10px 20px; } 
        #text-bio { font-family: 'Lora', serif; font-size: 15px; line-height: 1.25; margin: 0; color: #111; }

        .side-rel { width: 220px; background: rgba(255, 255, 255, 0.2); padding: 15px; overflow-y: auto; border-left: 1px solid rgba(0,0,0,0.05); }
        .rel-item { padding: 6px 10px; background: white; border-radius: 8px; font-size: 11px; margin-bottom: 5px; cursor: pointer; font-weight: 700; }

        #ai-chat-toggle { position: absolute; bottom: 20px; right: 20px; z-index: 6000; width: 55px; height: 55px; background: var(--navy); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #ai-chat-window { position: absolute; bottom: 85px; right: 20px; z-index: 6000; width: 320px; height: 450px; background: white; border-radius: 20px; display: none; flex-direction: column; overflow: hidden; }
        #ai-chat-messages { flex: 1; padding: 15px; overflow-y: auto; font-size: 13px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; line-height: 1.4; }
        .msg-ai { background: #f1f1f1; align-self: flex-start; }
        .msg-user { background: var(--blue); color: white; align-self: flex-end; }
    </style>
</head>
<body>

<div id="ui-container">
    <div id="filter-bar">
        <button onclick="location.reload()" style="background:none; border:none; cursor:pointer; font-size:16px;">â†º</button>
        <input type="text" id="search-name" placeholder="Nome..." oninput="filtra()">
        <input type="text" id="search-theme" placeholder="Argomento..." oninput="filtra()">
        <input type="text" id="search-city" placeholder="CittÃ ..." oninput="filtra()">
        <select id="filtro-regione" onchange="filtraRegione()">
            <option value="">Regione...</option>
            <option value="Piemonte">Piemonte</option><option value="Lombardia">Lombardia</option><option value="Toscana">Toscana</option>
            <option value="Emilia-Romagna">Emilia-Romagna</option><option value="Lazio">Lazio</option><option value="Liguria">Liguria</option>
            <option value="Veneto">Veneto</option><option value="Marche">Marche</option><option value="Umbria">Umbria</option>
        </select>
    </div>
    <div id="results-dropdown"></div>
</div>

<div id="map"></div>

<div id="details-panel">
    <div id="details-header">
        <div><b id="h-nome">NOMINATIVO</b> <span id="h-reg" style="font-size:10px; background:var(--blue); padding:2px 6px; border-radius:5px;">REGIONE</span></div>
        <div style="display:flex; align-items:center; gap:10px;">
            <span class="social-btn" id="share-wa">WhatsApp</span>
            <span class="social-btn" id="share-fb">Facebook</span>
            <button onclick="closeDetails()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>
    </div>
    <div id="details-content" style="display:flex;">
        <div class="main-col">
            <div class="video-box"><iframe id="vimeo-player" src="" width="100%" height="100%" frameborder="0" allowfullscreen></iframe></div>
            <div class="bio-box"><p id="text-bio"></p></div>
        </div>
        <div class="side-rel">
            <div style="font-size:9px; font-weight:800; opacity:0.5; margin-bottom:8px;">NELLA REGIONE</div>
            <div id="box-rel"></div>
        </div>
    </div>
</div>

<div id="ai-chat-toggle" onclick="toggleAIChat()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</div>

<div id="ai-chat-window">
    <div style="background:var(--navy); color:white; padding:12px; font-weight:bold; display:flex; justify-content:space-between;">
        <span>Archivista AI</span>
        <span onclick="toggleAIChat()" style="cursor:pointer;">&times;</span>
    </div>
    <div id="ai-chat-messages"></div>
    <div style="padding:10px; border-top:1px solid #eee;">
        <input type="text" id="ai-chat-input" placeholder="Chiedi all'archivio..." style="width:100%; border-radius:20px; border:1px solid #ddd; padding:8px 12px;" onkeypress="if(event.key==='Enter') sendAIMessage()">
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="libro.js"></script>

<script>
    let map = L.map('map', {zoomControl: false}).setView([42.0, 12.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = L.markerClusterGroup();
    map.addLayer(markers);
    let database = [];
    let searchTimeout;

    Papa.parse("progetto_mappa.csv", {
        download: true, header: true, skipEmptyLines: true,
        complete: function(res) { database = res.data; caricaMarker(); }
    });

    function caricaMarker(filtroFn = null, fit = false) {
        markers.clearLayers();
        let bounds = L.latLngBounds();
        let hasData = false;
        database.forEach(d => {
            if (!filtroFn || filtroFn(d)) {
                const lat = parseFloat(String(d.lat).replace(',','.'));
                const lon = parseFloat(String(d.lon).replace(',','.'));
                if (!isNaN(lat)) {
                    let m = L.marker([lat, lon]).on('click', () => openDetails(d));
                    markers.addLayer(m);
                    bounds.extend([lat, lon]);
                    hasData = true;
                }
            }
        });
        if (fit && hasData) map.flyToBounds(bounds, {padding: [50,50]});
    }

    function filtra() {
        clearTimeout(searchTimeout);
        const vn = document.getElementById('search-name').value.toLowerCase();
        const vt = document.getElementById('search-theme').value.toLowerCase();
        const vc = document.getElementById('search-city').value.toLowerCase();

        searchTimeout = setTimeout(() => {
            if (vc.length >= 3) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${vc},Italy&limit=1`)
                .then(r => r.json()).then(data => {
                    if (data.length > 0) map.flyTo([data[0].lat, data[0].lon], 11);
                });
            }

            if (vn.length >= 2 || vt.length >= 2) {
                let filtrati = database.filter(d => 
                    (vn === "" || d.nominativo.toLowerCase().includes(vn)) &&
                    (vt === "" || (d.scheda && d.scheda.toLowerCase().includes(vt)))
                ).slice(0, 40);
                updateDropdown(filtrati);
            } else {
                document.getElementById('results-dropdown').style.display = 'none';
            }
        }, 600);
    }

    function filtraRegione() {
        const reg = document.getElementById('filtro-regione').value;
        if (!reg) { document.getElementById('results-dropdown').style.display = 'none'; caricaMarker(); return; }
        let filtrati = database.filter(d => d.regione === reg).slice(0, 50);
        updateDropdown(filtrati);
        caricaMarker(d => d.regione === reg, true);
    }

    function updateDropdown(lista) {
        const drop = document.getElementById('results-dropdown');
        if (lista.length > 0) {
            drop.innerHTML = lista.map(d => `<div class="res-item" onclick="apri('${d.nominativo.replace(/'/g, "\\'")}')"><b>${d.nominativo}</b> <span>${d.regione}</span></div>`).join('');
            drop.style.display = 'block';
        } else drop.style.display = 'none';
    }

    function apri(nome) {
        const d = database.find(x => x.nominativo.trim().toLowerCase() === nome.trim().toLowerCase());
        if(d) { 
            openDetails(d); 
            document.getElementById('results-dropdown').style.display='none'; 
            const lat = parseFloat(String(d.lat).replace(',','.'));
            const lon = parseFloat(String(d.lon).replace(',','.'));
            if(!isNaN(lat)) map.flyTo([lat, lon], 14);
        }
    }

    function openDetails(d) {
        document.getElementById('h-nome').innerText = d.nominativo;
        document.getElementById('h-reg').innerText = d.regione;
        document.getElementById('text-bio').innerText = d.scheda || "Biografia non disponibile.";
        document.getElementById('vimeo-player').src = d.id ? `https://player.vimeo.com/video/${d.id}?autoplay=0` : "";
        
        const url = window.location.href;
        document.getElementById('share-wa').onclick = () => window.open(`https://wa.me/?text=Testimonianza di ${d.nominativo}: ${url}`);
        document.getElementById('share-fb').onclick = () => window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`);

        const rel = database.filter(x => x.regione === d.regione && x.nominativo !== d.nominativo).slice(0, 12);
        document.getElementById('box-rel').innerHTML = rel.map(r => `<div class="rel-item" onclick="apri('${r.nominativo.replace(/'/g, "\\'")}')">${r.nominativo}</div>`).join('');
        document.getElementById('details-panel').classList.add('open');
    }

    function closeDetails() { 
        document.getElementById('details-panel').classList.remove('open'); 
        setTimeout(() => { document.getElementById('vimeo-player').src = ""; }, 500);
    }

    function toggleAIChat() { 
        const w = document.getElementById('ai-chat-window');
        w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
    }

    async function sendAIMessage() {
        const key = localStorage.getItem('gemini_key') || prompt("Inserisci API Key:");
        if(!key) return; localStorage.setItem('gemini_key', key);

        const input = document.getElementById('ai-chat-input');
        const box = document.getElementById('ai-chat-messages');
        const txt = input.value.trim();
        if(!txt) return;

        box.innerHTML += `<div class="msg msg-user">${txt}</div>`;
        input.value = "";
        
        const selezione = database.filter(d => 
            `${d.nominativo} ${d.scheda} ${d.regione} ${d.cittÃ _nascita}`.toLowerCase().includes(txt.toLowerCase())
        ).slice(0, 40);

        const contestCSV = selezione.length > 0 
            ? selezione.map(d => `IDENTITÃ€: ${d.nominativo} | REGIONE: ${d.regione} | BIOGRAFIA: ${d.scheda}`).join("\n")
            : "NESSUN TESTIMONE TROVATO NEL CSV.";

        box.innerHTML += `<div class="msg msg-ai" id="ai-loading">...</div>`;
        const aiMsg = document.getElementById('ai-loading');
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:streamGenerateContent?alt=sse&key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Agisci come Archivista rigoroso. La tua Bibbia Ã¨ il CSV dei TESTIMONI.
                    REGOLE MANDATORIE:
                    1. Se la domanda riguarda nomi, luoghi o temi presenti nei TESTIMONI (CSV), DEVI iniziare parlando di loro. 
                    2. USA SEMPRE i link [[Nome Cognome]] per ogni partigiano citato dal CSV.
                    3. IL LIBRO Ãˆ SECONDARIO: Puoi citarlo solo DOPO il CSV per contesto storico.
                    4. Se NON trovi testimoni nel CSV, dillo chiaramente prima di usare il libro.
                    DATI TESTIMONI (CSV): ${contestCSV}
                    CONTESTO STORICO (LIBRO): ${typeof TESTO_LIBRO !== 'undefined' ? TESTO_LIBRO.substring(0, 12000) : 'Non disponibile'}
                    Domanda: "${txt}"` }]}]
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";
            aiMsg.id = ""; 

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");
                for(const line of lines) {
                    if(line.startsWith("data: ")) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            const delta = json.candidates[0].content.parts[0].text;
                            if(delta) {
                                fullText += delta;
                                aiMsg.innerHTML = fullText
                                    .replace(/\[\[(.*?)\]\]/g, (m, n) => `<b style="color:red;cursor:pointer;text-decoration:underline;" onclick="apri('${n.replace(/'/g, "\\'")}')">${n}</b>`)
                                    .replace(/<cite>(.*?)<\/cite>/g, (m, n) => `<span class="citazione-libro">ðŸ“– "${n}"</span>`);
                                box.scrollTop = box.scrollHeight;
                            }
                        } catch(e){}
                    }
                }
            }
        } catch(e) { aiMsg.innerText = "Errore di connessione."; }
    }
</script>
</body>
</html>
