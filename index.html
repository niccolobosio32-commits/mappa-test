<script>
    // ... (parte iniziale identica fino a sendAIMessage)

    async function sendAIMessage() {
        const key = getApiKey();
        if (!key) return;

        const input = document.getElementById('ai-chat-input');
        const box = document.getElementById('ai-chat-messages');
        const userText = input.value.trim();
        if (!userText) return;

        box.innerHTML += `<div class="msg msg-user">${userText}</div>`;
        input.value = "";
        const loadingId = "load-" + Date.now();
        box.innerHTML += `<div id="${loadingId}" class="msg msg-ai">Analizzando l'archivio con Gemini 2.5...</div>`;
        box.scrollTop = box.scrollHeight;

        try {
            const termini = userText.toLowerCase().split(/\s+/).filter(t => t.length > 2);
            let matchSemplici = database.filter(d => {
                const testoDoc = `${d.nominativo} ${d.regione} ${d.scheda}`.toLowerCase();
                return termini.some(t => testoDoc.includes(t));
            });

            matchSemplici.sort((a, b) => {
                const contaA = termini.filter(t => `${a.nominativo} ${a.scheda}`.toLowerCase().includes(t)).length;
                const contaB = termini.filter(t => `${b.nominativo} ${b.scheda}`.toLowerCase().includes(t)).length;
                return contaB - contaA;
            });

            const selezione = matchSemplici.slice(0, 25);
            if (selezione.length === 0) {
                document.getElementById(loadingId).innerText = "Nessuna testimonianza trovata per questo tema.";
                return;
            }

            const contestStr = selezione.map(d => 
                `PARTIGIANO: ${d.nominativo} | REGIONE: ${d.regione} | STORIA: ${d.scheda?.substring(0, 450)}...`
            ).join("\n\n");

            // URL AGGIORNATO PER GEMINI 2.5 FLASH
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ 
                        parts: [{ text: `Sei l'assistente dell'Archivio Partigiani. Usa questi dati per rispondere:
                        
                        ${contestStr}

                        DOMANDA: "${userText}"
                        
                        REGOLE:
                        1. Elenco puntato se sono piÃ¹ persone.
                        2. Nome tra doppie quadre [[Nome Cognome]].
                        3. Vai SEMPRE a capo tra una persona e l'altra.
                        4. Sii schematico e non usare grassetti.` }] 
                    }] 
                })
            });

            const data = await response.json();
            if(data.error) throw new Error(data.error.message);

            const aiText = data.candidates[0].content.parts[0].text;
            const testoLinkato = aiText.replace(/\[\[(.*?)\]\]/g, (match, nome) => {
                const nomePulito = nome.trim();
                const esiste = database.find(d => d.nominativo.toLowerCase() === nomePulito.toLowerCase());
                if(esiste) {
                    const nomeEscaped = esiste.nominativo.replace(/'/g, "\\'");
                    return `<b style="color:#3498db; cursor:pointer; text-decoration:underline;" onclick="apri('${nomeEscaped}')">${nomePulito}</b>`;
                }
                return `<b>${nomePulito}</b>`;
            });

            document.getElementById(loadingId).innerHTML = testoLinkato;

        } catch (e) {
            document.getElementById(loadingId).innerText = "Errore: " + e.message;
        }
        box.scrollTop = box.scrollHeight;
    }

    // --- CORREZIONE FUNZIONE REGIONE (Chiusa correttamente) ---
    function filtraRegione() {
        const reg = document.getElementById('filtro-regione').value;
        caricaMarker(reg ? d => d.regione === reg : null, !!reg);
        const drop = document.getElementById('results-dropdown');
        if (reg) {
            let filtrati = database.filter(d => d.regione === reg).slice(0, 30);
            updateDropdown(filtrati);
            drop.style.display = 'block';
        } else {
            drop.style.display = 'none';
        }
    } // <--- Questa parentesi mancava nel tuo codice originale

    function apri(nome) {
        const d = database.find(x => x.nominativo === nome);
        if(!d) return;
        document.getElementById('results-dropdown').style.display = 'none';
        openDetails(d);
        const lat = parseFloat(d.lat?.replace(',','.'));
        const lon = parseFloat(d.lon?.replace(',','.'));
        if(!isNaN(lat)) map.flyTo([lat, lon], 14);
    }

    function openDetails(d) {
        document.getElementById('h-nome').innerText = d.nominativo;
        document.getElementById('h-reg').innerText = d.regione;
        document.getElementById('text-bio').innerText = d.scheda || "";
        document.getElementById('vimeo-player').src = d.id ? `https://player.vimeo.com/video/${d.id}` : "";
        
        const shareURL = window.location.origin + window.location.pathname + "?p=" + encodeURIComponent(d.nominativo);
        document.getElementById('fb-share').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareURL)}`;
        document.getElementById('wa-share').href = `https://api.whatsapp.com/send?text=${encodeURIComponent("Intervista: " + shareURL)}`;
        document.getElementById('copy-link').onclick = (e) => { e.preventDefault(); navigator.clipboard.writeText(shareURL); alert("Link copiato!"); };

        const rel = database.filter(x => x.regione === d.regione && x.nominativo !== d.nominativo).slice(0, 8);
        document.getElementById('box-rel').innerHTML = rel.map(r => `<div class="rel-item" onclick="apri('${r.nominativo.replace(/'/g, "\\'")}')">${r.nominativo}</div>`).join('');
        document.getElementById('details-panel').classList.add('open');
    }

    function closeDetails() {
        document.getElementById('details-panel').classList.remove('open');
        setTimeout(() => { document.getElementById('vimeo-player').src = ""; }, 500);
    }

    function toggleAIChat() {
        const win = document.getElementById('ai-chat-window');
        win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none';
    }

    map.on('click', () => { closeDetails(); document.getElementById('results-dropdown').style.display = 'none'; });
</script>
